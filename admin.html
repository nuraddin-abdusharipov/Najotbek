<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel — Test Platforma</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <div class="admin-wrap">
    <div class="admin-header">
      <div class="admin-info">
        <h2><i class="fas fa-crown"></i> Admin Panel</h2>
        <p class="muted">Platformani boshqarish va monitoring qilish</p>
      </div>
      <div class="admin-actions">
        <button id="refreshData" class="btn ghost">
          <i class="fas fa-sync-alt"></i> Yangilash
        </button>
      </div>
    </div>

    <!-- Add Question Section -->
    <div class="admin-section">
      <h3><i class="fas fa-plus-circle"></i> Savol qo'shish</h3>
      <div class="card question-form">
        <div class="form-row">
          <div class="input-group">
            <label for="qdir">Yo'nalish</label>
            <select id="qdir">
              <option value="natural">Natural sonlar</option>
              <option value="haqiqiy">Haqiqiy sonlar</option>
              <option value="matnli">Matnli masalalar</option>
              <option value="ratsional">Ratsional ko'rsatkichli daraja</option>
              <option value="sonli">Sonli ketma-ketliklar</option>
              <option value="trigonometriya">Trigonometriya asoslari</option>
              <option value="algebraik">Algebraik ifodalar</option>
            </select>
          </div>
          <div class="input-group">
            <label for="qdifficulty">Murakkablik</label>
            <select id="qdifficulty">
              <option value="oson">Oson</option>
              <option value="ortacha">O'rtacha</option>
              <option value="qiyin">Qiyin</option>
            </select>
          </div>
        </div>

        <div class="input-group">
          <label for="qtext">Savol matni</label>
          <textarea id="qtext" rows="3" placeholder="Savolni kiriting..."></textarea>
        </div>

        <div class="input-group">
          <label for="qimage"><i class="fas fa-image"></i> Savol uchun rasm (ixtiyoriy)</label>
          <input type="file" id="qimage" accept="image/*">
        </div>

        <div class="options-grid">
          <div class="input-group correct-option"><label for="opt1"><i class="fas fa-check-circle"></i> To'g'ri javob</label><input id="opt1" placeholder="To'g'ri javobni kiriting"></div>
          <div class="input-group"><label for="opt2">Noto'g'ri javob 1</label><input id="opt2" placeholder="Noto'g'ri javob"></div>
          <div class="input-group"><label for="opt3">Noto'g'ri javob 2</label><input id="opt3" placeholder="Noto'g'ri javob"></div>
          <div class="input-group"><label for="opt4">Noto'g'ri javob 3</label><input id="opt4" placeholder="Noto'g'ri javob"></div>
        </div>

        <button id="addQuestion" class="btn primary"><i class="fas fa-save"></i> Savol qo'shish</button>
        <p id="qmsg" class="muted"></p>
      </div>
    </div>

    <!-- Questions Table -->
    <div class="admin-section">
      <div class="section-header">
        <h3><i class="fas fa-list"></i> Savollar ro'yxati</h3>
      </div>
      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Savol</th>
                <th>Yo'nalish</th>
                <th>Murakkablik</th>
                <th>Rasm</th>
                <th>Amallar</th>
              </tr>
            </thead>
            <tbody id="questionsTable">
              <tr><td colspan="5" class="empty-table"><i class="fas fa-spinner fa-spin"></i> Savollar yuklanmoqda...</td></tr>
            </tbody>
          </table>
        </div>
        <div style="text-align:center; margin-top:10px;">
          <button id="loadMore" class="btn ghost">Keyingi 20 ta</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script type="module">
import { db, storage } from './firebase.js';
import { collection, query, orderBy, limit, startAfter, addDoc, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

let lastVisible = null;

// Load questions with batch and pagination
async function loadQuestions(batchSize=20, reset=false){
  const table = document.getElementById('questionsTable');
  if(reset){ table.innerHTML='<tr><td colspan="5" class="empty-table"><i class="fas fa-spinner fa-spin"></i> Yuklanmoqda...</td></tr>'; lastVisible=null; }

  try{
    let qRef = query(collection(db,'questions'), orderBy('createdAt','desc'), limit(batchSize));
    if(lastVisible){ qRef = query(collection(db,'questions'), orderBy('createdAt','desc'), startAfter(lastVisible), limit(batchSize)); }

    const snap = await getDocs(qRef);
    if(snap.empty){ if(reset){ table.innerHTML='<tr><td colspan="5" class="empty-table">Savol topilmadi</td></tr>'; } else { alert('Yana savol topilmadi'); } return; }

    if(reset) table.innerHTML='';
    lastVisible = snap.docs[snap.docs.length-1];

    snap.forEach(q=>{
      const d=q.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${d.question}</td>
        <td>${d.direction}</td>
        <td>${d.difficulty}</td>
        <td>${d.imageUrl ? '<i class="fas fa-image text-success"></i>':'<i class="fas fa-times text-muted"></i>'}</td>
        <td><button class="btn danger deleteBtn" data-id="${q.id}"><i class="fas fa-trash"></i></button></td>
      `;
      table.appendChild(tr);
    });

    document.querySelectorAll('.deleteBtn').forEach(btn=>{
      btn.onclick=async()=>{
        if(!confirm('Ushbu savolni o‘chirishni xohlaysizmi?')) return;
        await deleteDoc(doc(db,'questions',btn.dataset.id));
        btn.closest('tr').remove();
      };
    });

  }catch(e){ console.error(e); table.innerHTML=`<tr><td colspan="5">Xatolik: ${e.message}</td></tr>`; }
}

// Add question
document.getElementById('addQuestion').onclick=async()=>{
  const qdir=document.getElementById('qdir').value;
  const qdifficulty=document.getElementById('qdifficulty').value;
  const qtext=document.getElementById('qtext').value.trim();
  const opt1=document.getElementById('opt1').value.trim();
  const opt2=document.getElementById('opt2').value.trim();
  const opt3=document.getElementById('opt3').value.trim();
  const opt4=document.getElementById('opt4').value.trim();
  const qimage=document.getElementById('qimage').files[0];
  const qmsg=document.getElementById('qmsg');

  if(!qdir||!qdifficulty||!qtext||!opt1||!opt2||!opt3||!opt4){ qmsg.textContent='Barcha maydonlarni to‘ldiring'; return; }

  let imageUrl='';
  if(qimage){
    const imgRef=ref(storage,'questions/'+Date.now()+'_'+qimage.name);
    await uploadBytes(imgRef,qimage);
    imageUrl=await getDownloadURL(imgRef);
  }

  await addDoc(collection(db,'questions'),{
    direction:qdir, difficulty:qdifficulty, question:qtext,
    options:[opt1,opt2,opt3,opt4], correctIndex:0, imageUrl:imageUrl, createdAt:serverTimestamp()
  });

  qmsg.textContent='Savol muvaffaqiyatli qo‘shildi';
  document.getElementById('qtext').value='';
  ['opt1','opt2','opt3','opt4'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('qimage').value='';

  loadQuestions(20,true);
}

// Load initial batch
loadQuestions(20,true);
document.getElementById('loadMore').onclick=()=>loadQuestions(20,false);

</script>
</body>
</html>
