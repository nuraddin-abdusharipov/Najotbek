<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test â€” Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="test-wrap">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="title">Test</h3>
        <div>Ball: <strong id="score">0</strong>/60</div>
      </div>
      
      <!-- Progress bar -->
      <div class="progress-bar">
        <div class="progress" id="progress" style="width: 0%"></div>
      </div>
      
      <hr/>
      <div id="qbox">
        <div id="qcount" class="muted">0 / 30</div>
        <h2 id="qtext"></h2>
        <div class="options" id="opts"></div>
        <div style="display:flex;justify-content:space-between;margin-top:12px;align-items:center">
          <div class="muted">Vaqt: <span id="timer" class="timer">20</span>s</div>
          <button id="next" class="btn ghost hidden">
            <i class="fas fa-arrow-right"></i>
            Keyingi savol
          </button>
        </div>
      </div>
      <div id="result" class="hidden" style="margin-top:12px">
        <h3>Test natijalari</h3>
        <div class="card" style="text-align: center; padding: 30px;">
          <h2 style="font-size: 3rem; margin-bottom: 10px;" id="finalScore">0</h2>
          <p style="font-size: 1.2rem;">Jami ball: <strong id="totalScore">0</strong>/60</p>
          <p id="resMsg" class="muted"></p>
          <div style="margin-top: 20px;">
            <button onclick="location.href='user.html'" class="btn primary">
              <i class="fas fa-home"></i>
              Bosh sahifaga qaytish
            </button>
            <button onclick="location.reload()" class="btn ghost">
              <i class="fas fa-redo"></i>
              Qayta urinish
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { collection, getDocs, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

onAuthStateChanged(auth, user => {
  if (!user) location.href = 'login.html';
});

const QUESTIONS_PER_TEST = 30;
const TIME_PER_Q = 20;
const POINTS_PER_Q = 2;

let questions = [];
let index = 0;
let score = 0;
let timerInterval = null;

const dir = localStorage.getItem('direction') || 'javascript';
document.getElementById('title').textContent = "Yo'nalish: " + dir.charAt(0).toUpperCase() + dir.slice(1);

async function loadQuestions() {
  try {
    const qSnap = await getDocs(query(collection(db, 'questions'), where('direction', '==', dir)));
    qSnap.forEach(d => questions.push({ id: d.id, ...d.data() }));
    
    if (questions.length === 0) {
      alert("Ushbu yo'nalishda savollar topilmadi");
      location.href = 'user.html';
      return;
    }
    
    shuffle(questions);
    questions = questions.slice(0, QUESTIONS_PER_TEST);
    showQuestion();
  } catch (error) {
    console.error("Error loading questions:", error);
    alert("Savollarni yuklashda xatolik yuz berdi");
  }
}

function showQuestion() {
  if (index >= questions.length) {
    finishTest();
    return;
  }
  
  // Update progress bar
  const progress = ((index + 1) / questions.length) * 100;
  document.getElementById('progress').style.width = `${progress}%`;
  
  const q = questions[index];
  document.getElementById('qcount').textContent = (index + 1) + ' / ' + questions.length;
  document.getElementById('qtext').textContent = q.question;
  const opts = document.getElementById('opts');
  opts.innerHTML = '';

  const shuffledOptions = [...q.options];
  const shuffledIndices = Array.from({ length: q.options.length }, (_, i) => i);
  shuffle(shuffledIndices);
  
  const newCorrectIndex = shuffledIndices.indexOf(q.correctIndex);
  
  shuffledIndices.forEach((originalIndex, i) => {
    const el = document.createElement('div');
    el.className = 'option';
    el.textContent = q.options[originalIndex];
    el.onclick = () => choose(i === newCorrectIndex, el);
    opts.appendChild(el);
  });
  startTimer();
}

function choose(correct, el) {
  clearInterval(timerInterval);
  document.querySelectorAll('.option').forEach(o => o.classList.add('disabled'));
  
  if (correct) {
    el.classList.add('correct');
    score += POINTS_PER_Q;
    document.getElementById('score').textContent = score;
  } else {
    el.classList.add('incorrect');
    // Highlight correct answer
    document.querySelectorAll('.option').forEach(opt => {
      if (opt.classList.contains('correct')) return;
      const optionText = opt.textContent;
      const correctAnswer = questions[index].options[questions[index].correctIndex];
      if (optionText === correctAnswer) {
        opt.classList.add('correct');
      }
    });
  }
  
  document.getElementById('next').classList.remove('hidden');
}

document.getElementById('next').addEventListener('click', () => {
  document.getElementById('next').classList.add('hidden');
  index++;
  showQuestion();
});

function startTimer() {
  let t = TIME_PER_Q;
  const timerEl = document.getElementById('timer');
  timerEl.textContent = t;
  timerEl.className = 'timer';
  
  timerInterval = setInterval(() => {
    t--;
    timerEl.textContent = t;
    
    // Warning when time is running out
    if (t <= 5) {
      timerEl.classList.add('warning');
    }
    
    if (t <= 0) {
      clearInterval(timerInterval);
      document.querySelectorAll('.option').forEach(o => o.classList.add('disabled'));
      document.getElementById('next').classList.remove('hidden');
    }
  }, 1000);
}

async function finishTest() {
  document.getElementById('qbox').classList.add('hidden');
  document.getElementById('result').classList.remove('hidden');
  document.getElementById('finalScore').textContent = score;
  document.getElementById('totalScore').textContent = score;
  
  // Calculate percentage
  const percentage = (score / (questions.length * POINTS_PER_Q)) * 100;
  
  // Set result message based on score
  const resMsg = document.getElementById('resMsg');
  if (percentage >= 80) {
    resMsg.textContent = "A'lo natija! Siz bu yo'nalishda yaxshi bilimga egasiz.";
    resMsg.style.color = "var(--accent3)";
  } else if (percentage >= 60) {
    resMsg.textContent = "Yaxshi natija! Biroz ko'proq mashq qilishingiz kerak.";
    resMsg.style.color = "var(--accent2)";
  } else {
    resMsg.textContent = "Qoniqarsiz natija. Bu yo'nalish bo'yicha qayta o'rganish tavsiya etiladi.";
    resMsg.style.color = "var(--accent4)";
  }
  
  await saveResult();
}

async function saveResult() {
  try {
    const user = auth.currentUser;
    if (!user) return;
    
    let username = user.email;
    const uSnap = await getDocs(query(collection(db, 'users'), where('uid', '==', user.uid)));
    if (!uSnap.empty) {
      username = uSnap.docs[0].data().username || username;
    }
    
    await addDoc(collection(db, 'results'), {
      uid: user.uid,
      username,
      category: dir,
      score,
      maxScore: questions.length * POINTS_PER_Q,
      percentage: (score / (questions.length * POINTS_PER_Q)) * 100,
      attempts: 1,
      date: serverTimestamp()
    });
    
  } catch (e) {
    console.error("Error saving result:", e);
  }
}

function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
}

loadQuestions();
</script>
  <script type="module" src="init-helper.js"></script>
</body>
</html>