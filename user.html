<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Foydalanuvchi Paneli â€” Test Platforma</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="user-wrap">
      <header class="user-header">
        <div class="user-info">
          <h2><i class="fas fa-user"></i> Xush kelibsiz, <span id="username">...</span></h2>
          <p class="muted" id="userEmail"></p>
        </div>
        <button id="logout" class="btn ghost">
          <i class="fas fa-sign-out-alt"></i> Chiqish
        </button>
      </header>

      <div class="card">
        <h3><i class="fas fa-graduation-cap"></i> Test yo'nalishini tanlang</h3>
        <p class="muted">Quyidagi yo'nalishlardan birini tanlab testni boshlang</p>

        <div class="direction-info">
          <div class="info-card">
            <i class="fas fa-info-circle"></i>
            <div>
              <strong>15 ta savol</strong>
              <span>Har bir testda</span>
            </div>
          </div>
          <div class="info-card">
            <i class="fas fa-clock"></i>
            <div>
              <strong>2 soat</strong>
              <span>Umumiy vaqt</span>
            </div>
          </div>
          <div class="info-card">
            <i class="fas fa-star"></i>
            <div>
              <strong>100 ball</strong>
              <span>Maksimal ball</span>
            </div>
          </div>
        </div>

        <div class="direction-selector">
          <div class="selector-label">
            <i class="fas fa-list"></i>
            Yo'nalishni tanlang:
          </div>
          <select id="directionSelect" class="direction-select">
            <option value="natural">Natural sonlar</option>
            <option value="haqiqiy">Haqiqiy sonlar</option>
            <option value="matnli">Matnli masalalar</option>
            <option value="ratsional">Ratsional ko'rsatkichli daraja</option>
            <option value="sonli">Sonli ketma-ketliklar</option>
            <option value="trigonometriya">Trigonometriya asoslari</option>
            <option value="algebraik">Algebraik ifodalar</option>
            <option value="korsatkichli">Ko'rsatkichli funksiya</option>
            <option value="logarifmetik">Logarifmetik funksiya</option>
          </select>
        </div>

        <div class="action-buttons">
          <button id="startTest" class="btn primary start-btn">
            <i class="fas fa-play"></i>
            Testni boshlash
          </button>
        </div>
      </div>

      <!-- Recent Results -->
      <div class="recent-results">
        <h3><i class="fas fa-history"></i> Oxirgi natijalar</h3>
        <div class="card">
          <div id="recentResultsList">
            <div class="loading-spinner-large"></div>
            <p class="muted">Yuklanmoqda...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

// Foydalanuvchi holatini tekshirish
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  // Agar admin bo'lsa -> admin sahifasiga yo'naltir
  if (user.email === "admin@gmail.com") {
    location.href = "admin.html";
    return;
  }

  // Foydalanuvchi ma'lumotlarini chiqarish
  const userSnap = await getDocs(query(collection(db, "users"), where("uid", "==", user.uid)));
  if (!userSnap.empty) {
    const userData = userSnap.docs[0].data();
    document.getElementById("username").textContent = userData.username || "Foydalanuvchi";
  } else {
    document.getElementById("username").textContent = user.displayName || "Foydalanuvchi";
  }
  
  document.getElementById("userEmail").textContent = user.email;
  await loadRecentResults(user.uid);
});

// Oxirgi natijalarni yuklash
async function loadRecentResults(uid) {
  try {
    const resultsSnap = await getDocs(
      query(
        collection(db, "results"), 
        where("uid", "==", uid)
      )
    );

    const resultsList = document.getElementById("recentResultsList");
    
    if (resultsSnap.empty) {
      resultsList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <p>Hozircha test natijalari mavjud emas</p>
        </div>
      `;
      return;
    }

    // Client tomonda saralash
    const results = [];
    resultsSnap.forEach(doc => {
      results.push({ id: doc.id, ...doc.data() });
    });
    
    // Date bo'yicha saralash (client tomonda)
    results.sort((a, b) => {
      const dateA = a.date?.seconds || 0;
      const dateB = b.date?.seconds || 0;
      return dateB - dateA; // Teskari tartib
    }).slice(0, 5); // Faqat 5 ta oxirgi natija

    let html = '';
    results.forEach(data => {
      const date = data.date?.seconds ? new Date(data.date.seconds * 1000).toLocaleDateString() : "Noma'lum";
      const percentage = data.percentage || 0;
      
      let percentageClass = 'low';
      if (percentage >= 80) percentageClass = 'high';
      else if (percentage >= 60) percentageClass = 'medium';

      html += `
        <div class="result-item">
          <div class="result-info">
            <div class="result-category">${data.category}</div>
            <div class="result-date">${date}</div>
          </div>
          <div class="result-stats">
            <div class="result-score">${data.score || 0} ball</div>
            <div class="result-percentage ${percentageClass}">
              ${percentage.toFixed(1)}%
            </div>
          </div>
        </div>
      `;
    });

    resultsList.innerHTML = html;

  } catch (error) {
    console.error("Natijalarni yuklashda xatolik:", error);
    document.getElementById("recentResultsList").innerHTML = `
      <p class="error-message">Natijalarni yuklashda xatolik yuz berdi</p>
    `;
  }
}

// Testni boshlash
document.getElementById("startTest").addEventListener("click", () => {
  const selectedDirection = document.getElementById("directionSelect").value;
  localStorage.setItem('direction', selectedDirection);
  location.href = "test.html";
});

// Chiqish
document.getElementById("logout").addEventListener("click", () => {
  signOut(auth).then(() => location.href = "login.html");
});
</script>

<style>
.user-wrap {
  max-width: 800px;
  margin: 0 auto;
}

.user-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.direction-info {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}

.info-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 10px;
  border: 1px solid var(--card-border);
}

.info-card i {
  font-size: 1.5rem;
  color: var(--accent2);
}

.info-card div {
  display: flex;
  flex-direction: column;
}

.info-card strong {
  font-size: 1.1rem;
}

.info-card span {
  font-size: 0.8rem;
  color: var(--muted);
}

.direction-selector {
  margin: 2rem 0;
}

.selector-label {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
  font-weight: 600;
}

.direction-select {
  width: 100%;
  margin-bottom: 1rem;
}

.action-buttons {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
}

.start-btn {
  flex: 1;
  font-size: 1.1rem;
  padding: 15px 25px;
}

.recent-results {
  margin-top: 3rem;
}

.results-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.result-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 10px;
  border: 1px solid var(--card-border);
}

.result-category {
  font-weight: 600;
  color: var(--accent1);
}

.result-score {
  font-weight: 700;
}

.result-percentage {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
}

.result-percentage.high {
  background: rgba(16, 185, 129, 0.2);
  color: var(--accent3);
}

.result-percentage.medium {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}

.result-percentage.low {
  background: rgba(239, 68, 68, 0.2);
  color: var(--accent4);
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--muted);
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 15px;
  opacity: 0.5;
}

.loading-spinner-large {
  width: 40px;
  height: 40px;
  border: 3px solid transparent;
  border-top: 3px solid var(--accent1);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 15px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .user-header {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }
  
  .direction-info {
    grid-template-columns: 1fr;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .result-item {
    flex-direction: column;
    gap: 10px;
    text-align: center;
  }
}
</style>
</body>
</html>
