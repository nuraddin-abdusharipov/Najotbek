<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Foydalanuvchi Paneli â€” Test Platforma</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="user-wrap">
      <header class="user-header">
        <div class="user-info">
          <h2><i class="fas fa-user"></i> Xush kelibsiz, <span id="username">...</span></h2>
          <p class="muted" id="userEmail"></p>
        </div>
        <button id="logout" class="btn ghost">
          <i class="fas fa-sign-out-alt"></i> Chiqish
        </button>
      </header>

      <div class="card">
        <h3><i class="fas fa-graduation-cap"></i> Test yo'nalishini tanlang</h3>
        <p class="muted">Quyidagi yo'nalishlardan birini tanlab testni boshlang</p>

        <div class="direction-info">
          <div class="info-card">
            <i class="fas fa-info-circle"></i>
            <div>
              <strong>15 ta savol</strong>
              <span>Har bir testda</span>
            </div>
          </div>
          <div class="info-card">
            <i class="fas fa-clock"></i>
            <div>
              <strong>2 soat</strong>
              <span>Umumiy vaqt</span>
            </div>
          </div>
          <div class="info-card">
            <i class="fas fa-star"></i>
            <div>
              <strong>100 ball</strong>
              <span>Maksimal ball</span>
            </div>
          </div>
        </div>

        <div class="direction-selector">
          <div class="selector-label">
            <i class="fas fa-list"></i>
            Yo'nalishni tanlang:
          </div>
          <select id="directionSelect" class="direction-select">
            <option value="Boshlangich">Boshlang'ich matematika</option>
            <option value="Tenglama">Tenglama yechish</option>
            <option value="Grafik">Grafik analiz</option>
            <option value="Oddiy">Oddiy masalalar</option>
          </select>
        </div>

        <div class="action-buttons">
          <button id="startTest" class="btn primary start-btn">
            <i class="fas fa-play"></i>
            Testni boshlash
          </button>
        </div>
      </div>

      <!-- Recent Results -->
      <div class="recent-results">
        <h3><i class="fas fa-history"></i> Oxirgi natijalar</h3>
        <div class="card">
          <div id="recentResultsList">
            <div class="loading-spinner-large"></div>
            <p class="muted">Yuklanmoqda...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { collection, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

// Foydalanuvchi holatini tekshirish
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  // Agar admin bo'lsa -> admin sahifasiga yo'naltir
  if (user.email === "admin@gmail.com") {
    location.href = "admin.html";
    return;
  }

  // Foydalanuvchi ma'lumotlarini chiqarish
  const userSnap = await getDocs(query(collection(db, "users"), where("uid", "==", user.uid)));
  if (!userSnap.empty) {
    const userData = userSnap.docs[0].data();
    document.getElementById("username").textContent = userData.username || "Foydalanuvchi";
  } else {
    document.getElementById("username").textContent = user.displayName || "Foydalanuvchi";
  }
  
  document.getElementById("userEmail").textContent = user.email;
  await loadRecentResults(user.uid);
});

// Oxirgi natijalarni yuklash
async function loadRecentResults(uid) {
  try {
    const resultsSnap = await getDocs(
      query(
        collection(db, "results"), 
        where("uid", "==", uid),
        orderBy("date", "desc"),
        limit(5)
      )
    );

    const resultsList = document.getElementById("recentResultsList");
    
    if (resultsSnap.empty) {
      resultsList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <p>Hozircha test natijalari mavjud emas</p>
        </div>
      `;
      return;
    }

    let html = '';
    resultsSnap.forEach(doc => {
      const data = doc.data();
      const date = data.date?.seconds ? new Date(data.date.seconds * 1000).toLocaleDateString() : "Noma'lum";
      const percentage = data.percentage || 0;
      
      let percentageClass = 'low';
      if (percentage >= 80) percentageClass = 'high';
      else if (percentage >= 60) percentageClass = 'medium';

      html += `
        <div class="result-item">
          <div class="result-info">
            <div class="result-category">${data.category}</div>
            <div class="result-date">${date}</div>
          </div>
          <div class="result-stats">
            <div class="result-score">${data.score || 0} ball</div>
            <div class="result-percentage ${percentageClass}">
              ${percentage.toFixed(1)}%
            </div>
          </div>
        </div>
      `;
    });

    resultsList.innerHTML = html;

  } catch (error) {
    console.error("Natijalarni yuklashda xatolik:", error);
    document.getElementById("recentResultsList").innerHTML = `
      <p class="error-message">Xatolik yuz berdi: ${error.message}</p>
    `;
  }
}

// Testni boshlash
document.getElementById("startTest").addEventListener("click", () => {
  const selectedDirection = document.getElementById("directionSelect").value;
  localStorage.setItem('direction', selectedDirection);
  location.href = "test.html";
});

// Chiqish
document.getElementById("logout").addEventListener("click", () => {
  signOut(auth).then(() => location.href = "login.html");
});
</script>
</body>
</html>
