<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test â€” Najotbek Ta'lim</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="test-wrap">
      <div class="test-header">
        <div class="test-info">
          <h3 id="testTitle">Test</h3>
          <div class="test-stats">
            <span>Ball: <strong id="score">0</strong>/100</span>
            <span class="timer-container">
              <i class="fas fa-clock"></i>
              <span id="timer">30:00</span>
            </span>
          </div>
        </div>
      </div>
      
      <!-- Progress bar -->
      <div class="progress-bar">
        <div class="progress" id="progress" style="width: 0%"></div>
      </div>
      
      <div class="question-container" id="qbox">
        <div id="qcount" class="muted">0 / 15</div>
        <h2 id="qtext"></h2>
        
        <!-- Rasm ko'rsatish uchun -->
        <div id="questionImage" class="question-image-container" style="display: none;">
          <img id="qimage" class="question-image" />
        </div>
        
        <div class="options" id="opts"></div>
        
        <div class="question-footer">
          <div class="muted">Savol: <span id="currentQuestion">1</span>/15</div>
          <button id="next" class="btn primary hidden">
            <i class="fas fa-arrow-right"></i>
            Keyingi savol
          </button>
        </div>
      </div>
      
      <div id="result" class="hidden">
        <div class="result-container">
          <h3>Test natijalari</h3>
          <div class="card result-card">
            <div class="result-score-display">
              <h2 id="finalScore">0</h2>
              <p>Jami ball: <strong id="totalScore">0</strong>/100</p>
              <div id="resMsg" class="result-message"></div>
            </div>
            
            <div class="result-details">
              <div class="detail-item">
                <i class="fas fa-check-circle"></i>
                <span>To'g'ri javoblar: <strong id="correctCount">0</strong></span>
              </div>
              <div class="detail-item">
                <i class="fas fa-times-circle"></i>
                <span>Noto'g'ri javoblar: <strong id="wrongCount">0</strong></span>
              </div>
              <div class="detail-item">
                <i class="fas fa-clock"></i>
                <span>Sarflangan vaqt: <strong id="timeSpent">0:00</strong></span>
              </div>
            </div>
            
            <div class="result-actions">
              <button onclick="location.href='user.html'" class="btn primary">
                <i class="fas fa-home"></i>
                Bosh sahifaga qaytish
              </button>
              <button onclick="location.reload()" class="btn ghost">
                <i class="fas fa-redo"></i>
                Qayta urinish
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { collection, getDocs, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

// Global sozlamalar
const QUESTIONS_PER_TEST = 15;
const TOTAL_TIME = 1800; // 30 daqiqa (1800 soniya)
const MAX_SCORE = 100;
const POINTS_PER_Q = Math.round(MAX_SCORE / QUESTIONS_PER_TEST);

let questions = [];
let currentQuestionIndex = 0;
let score = 0;
let timerInterval = null;
let timeLeft = TOTAL_TIME;
let correctAnswers = 0;
let wrongAnswers = 0;
let startTime = Date.now();

const direction = localStorage.getItem('direction') || 'Boshlangich';
document.getElementById('testTitle').textContent = `Yo'nalish: ${direction}`;

onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = 'login.html';
    return;
  }
  loadQuestions();
});

async function loadQuestions() {
  try {
    const qSnap = await getDocs(query(collection(db, 'questions'), where('direction', '==', direction)));
    qSnap.forEach(doc => {
      questions.push({ id: doc.id, ...doc.data() });
    });
    
    if (questions.length === 0) {
      alert("Ushbu yo'nalishda savollar topilmadi");
      location.href = 'user.html';
      return;
    }
    
    // Savollarni aralashtirish va 15 tasini tanlash
    shuffleArray(questions);
    questions = questions.slice(0, QUESTIONS_PER_TEST);
    
    startTest();
  } catch (error) {
    console.error("Savollarni yuklashda xatolik:", error);
    alert("Savollarni yuklashda xatolik yuz berdi");
  }
}

function startTest() {
  startTimer();
  showQuestion();
}

function showQuestion() {
  if (currentQuestionIndex >= questions.length) {
    finishTest();
    return;
  }
  
  // Progress yangilash
  const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
  document.getElementById('progress').style.width = `${progress}%`;
  document.getElementById('qcount').textContent = `${currentQuestionIndex + 1} / ${questions.length}`;
  document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
  
  const currentQ = questions[currentQuestionIndex];
  
  // Savol matni
  document.getElementById('qtext').textContent = currentQ.question;
  
  // Rasmni ko'rsatish
  const imageContainer = document.getElementById('questionImage');
  const qimage = document.getElementById('qimage');
  // test.html ichida
if (currentQ.imageUrl && currentQ.imageUrl.trim() !== '') {
  qimage.src = currentQ.imageUrl; // Base64 string to'g'ridan-to'g'ri ishlaydi
  imageContainer.style.display = 'block';
} else {
  imageContainer.style.display = 'none';
}
  
  // Variantlarni ko'rsatish
  const optionsContainer = document.getElementById('opts');
  optionsContainer.innerHTML = '';
  
  const shuffledOptions = [...currentQ.options];
  const shuffledIndices = Array.from({ length: currentQ.options.length }, (_, i) => i);
  shuffleArray(shuffledIndices);
  
  const correctIndexInShuffled = shuffledIndices.indexOf(currentQ.correctIndex);
  
  shuffledIndices.forEach((originalIndex, newIndex) => {
    const optionElement = document.createElement('div');
    optionElement.className = 'option';
    optionElement.textContent = currentQ.options[originalIndex];
    optionElement.onclick = () => selectAnswer(newIndex === correctIndexInShuffled, optionElement);
    optionsContainer.appendChild(optionElement);
  });
  
  document.getElementById('next').classList.add('hidden');
}

function selectAnswer(isCorrect, selectedElement) {
  clearInterval(timerInterval);
  
  // Barcha variantlarni bloklash
  document.querySelectorAll('.option').forEach(opt => {
    opt.classList.add('disabled');
  });
  
  if (isCorrect) {
    selectedElement.classList.add('correct');
    score += POINTS_PER_Q;
    correctAnswers++;
    document.getElementById('score').textContent = score;
  } else {
    selectedElement.classList.add('incorrect');
    wrongAnswers++;
    
    // To'g'ri javobni ko'rsatish
    document.querySelectorAll('.option').forEach(opt => {
      const optionText = opt.textContent;
      const correctAnswer = questions[currentQuestionIndex].options[questions[currentQuestionIndex].correctIndex];
      if (optionText === correctAnswer) {
        opt.classList.add('correct');
      }
    });
  }
  
  document.getElementById('next').classList.remove('hidden');
}

document.getElementById('next').addEventListener('click', () => {
  document.getElementById('next').classList.add('hidden');
  currentQuestionIndex++;
  showQuestion();
});

function startTimer() {
  updateTimerDisplay();
  
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    
    if (timeLeft <= 300) { // 5 daqiqa qolganda
      document.getElementById('timer').classList.add('warning');
    }
    
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      finishTest();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;
  document.getElementById('timer').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
}

async function finishTest() {
  clearInterval(timerInterval);
  document.getElementById('qbox').classList.add('hidden');
  document.getElementById('result').classList.remove('hidden');
  
  const timeSpent = TOTAL_TIME - timeLeft;
  const minutesSpent = Math.floor(timeSpent / 60);
  const secondsSpent = timeSpent % 60;
  
  document.getElementById('finalScore').textContent = score;
  document.getElementById('totalScore').textContent = score;
  document.getElementById('correctCount').textContent = correctAnswers;
  document.getElementById('wrongCount').textContent = wrongAnswers;
  document.getElementById('timeSpent').textContent = `${minutesSpent}:${secondsSpent < 10 ? '0' : ''}${secondsSpent}`;
  
  // Natija xabari
  const percentage = (score / MAX_SCORE) * 100;
  const resMsg = document.getElementById('resMsg');
  
  if (percentage >= 80) {
    resMsg.textContent = "A'lo natija! Siz bu yo'nalishda a'lo bilimga egasiz.";
    resMsg.className = 'result-message success';
  } else if (percentage >= 60) {
    resMsg.textContent = "Yaxshi natija! Biroz ko'proq mashq qilishingiz kerak.";
    resMsg.className = 'result-message warning';
  } else {
    resMsg.textContent = "Qoniqarsiz natija. Bu yo'nalish bo'yicha qayta o'rganish tavsiya etiladi.";
    resMsg.className = 'result-message error';
  }
  
  await saveResult(timeSpent);
}

async function saveResult(timeSpent) {
  try {
    const user = auth.currentUser;
    if (!user) return;
    
    let username = user.email;
    const userSnap = await getDocs(query(collection(db, 'users'), where('uid', '==', user.uid)));
    if (!userSnap.empty) {
      username = userSnap.docs[0].data().username || username;
    }
    
    await addDoc(collection(db, 'results'), {
      uid: user.uid,
      username: username,
      category: direction,
      score: score,
      maxScore: MAX_SCORE,
      percentage: (score / MAX_SCORE) * 100,
      correctAnswers: correctAnswers,
      wrongAnswers: wrongAnswers,
      totalQuestions: QUESTIONS_PER_TEST,
      timeSpent: timeSpent,
      date: serverTimestamp()
    });
    
  } catch (error) {
    console.error("Natijani saqlashda xatolik:", error);
  }
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}
</script>

<style>
.test-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.test-stats {
  display: flex;
  gap: 1.5rem;
  align-items: center;
}

.timer-container {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
}

.question-container {
  margin-top: 1.5rem;
}

.question-image-container {
  text-align: center;
  margin: 1rem 0;
}

.question-image {
  max-width: 100%;
  max-height: 250px;
  border-radius: 8px;
  border: 1px solid var(--card-border);
}

.question-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 1.5rem;
}

.result-container {
  text-align: center;
}

.result-card {
  padding: 2rem;
}

.result-score-display {
  margin-bottom: 2rem;
}

.result-score-display h2 {
  font-size: 3rem;
  margin-bottom: 0.5rem;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.result-details {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin: 2rem 0;
}

.detail-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  justify-content: center;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 8px;
}

.result-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 2rem;
}

.result-message {
  font-size: 1.1rem;
  font-weight: 600;
  margin-top: 1rem;
}

.result-message.success {
  color: var(--accent3);
}

.result-message.warning {
  color: #f59e0b;
}

.result-message.error {
  color: var(--accent4);
}

@media (max-width: 768px) {
  .test-header {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }
  
  .result-details {
    grid-template-columns: 1fr;
  }
  
  .result-actions {
    flex-direction: column;
  }
}
</style>

  <script type="module" src="init-helper.js"></script>
</body>

</html>
